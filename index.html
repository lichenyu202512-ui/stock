<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>博弈雷达 V18.0-终极决策大脑</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'PingFang SC', system-ui; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.4); }
        .input-dark { background: #000; border: 1px solid #1e293b; color: #fff; border-radius: 8px; }
        .high-glow { border: 1px solid #ef4444; box-shadow: 0 0 20px rgba(239,68,68,0.2); }
        .trade-card { background: linear-gradient(145deg, #0f172a, #1e293b); border-radius: 12px; border-left: 4px solid #3b82f6; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .tab-active { border-bottom: 2px solid #10b981; color: #10b981; }
    </style>
</head>
<body class="p-3 bg-slate-950 min-h-screen">

    <div class="max-w-md mx-auto space-y-4">
        
        <header class="glass p-4 rounded-2xl border-t-2 border-blue-500 shadow-2xl">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-black tracking-widest text-blue-400 uppercase">Global Alpha Monitor</span>
                <span id="updateTime" class="text-[9px] text-slate-500 font-mono italic">同步中...</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-3 text-center">
                <div class="bg-black/30 p-1.5 rounded-lg">
                    <div class="text-[8px] text-slate-500">美元指</div>
                    <div id="m_usd" class="text-[10px] font-bold text-white">--</div>
                </div>
                <div class="bg-black/30 p-1.5 rounded-lg">
                    <div class="text-[8px] text-slate-500">纳指CFD</div>
                    <div id="m_nas" class="text-[10px] font-bold">--</div>
                </div>
                <div class="bg-black/30 p-1.5 rounded-lg">
                    <div class="text-[8px] text-slate-500">北向(亿)</div>
                    <div id="m_north" class="text-[10px] font-bold">--</div>
                </div>
                <div class="bg-black/30 p-1.5 rounded-lg">
                    <div class="text-[8px] text-slate-500">原油</div>
                    <div id="m_oil" class="text-[10px] font-bold text-white">--</div>
                </div>
            </div>
            <div id="brainSpeech" class="text-[11px] text-blue-300 bg-blue-500/10 p-2.5 rounded-xl border border-blue-500/20 leading-relaxed italic">
                大脑正在扫描宏观因子...
            </div>
        </header>

        <main class="space-y-3">
            <div id="radarList" class="space-y-2 h-[42vh] overflow-y-auto pr-1">
                <div class="text-center py-10 text-slate-700 text-xs animate-pulse">正在侦察全市场机构异动...</div>
            </div>
        </main>

        <section class="glass p-4 rounded-2xl border-t-2 border-emerald-500">
            <div class="flex gap-2 mb-4">
                <input id="newInput" type="text" placeholder="输入股票名称或代码" class="flex-1 input-dark p-3 text-xs outline-none focus:border-emerald-500 transition-all">
                <button onclick="smartSearch()" class="bg-emerald-600 px-6 rounded-xl text-xs font-black text-white active:scale-95">诊断信号</button>
            </div>

            <div id="orderBox" class="hidden animate-in slide-in-from-bottom-4 duration-300">
                <div id="orderContent"></div>
                <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-slate-800">
                    <div class="col-span-2 text-[9px] text-slate-500 uppercase font-bold mb-1">操盘记录回传</div>
                    <input id="backPrice" type="number" step="0.01" placeholder="成交单价" class="input-dark p-2 text-xs">
                    <input id="backQty" type="number" placeholder="股数" class="input-dark p-2 text-xs">
                    <button onclick="saveTrade('BUY')" class="bg-blue-600 text-white py-2 rounded-lg text-[10px] font-black">记录建仓</button>
                    <button onclick="saveTrade('SELL')" class="bg-slate-700 text-slate-300 py-2 rounded-lg text-[10px] font-black">清仓复盘</button>
                </div>
            </div>
        </section>

        <div id="historyBox" class="p-1 space-y-2 pb-10"></div>
    </div>

    <script>
        // 初始化超级记忆库
        let tradeMemory = JSON.parse(localStorage.getItem('master_brain_v18') || '[]');
        const coreStocks = {'sh601899':'紫金矿业','sh601857':'中国石油','sh603993':'洛阳钼业','sz000725':'京东方A','sh601288':'农业银行','sh601318':'中国平安','sh601088':'中国神华'};

        async function fetchGBK(url) {
            const resp = await fetch(url);
            return new TextDecoder('gbk').decode(await resp.arrayBuffer());
        }

        async function updateBrain() {
            // 1. 模拟宏观因子捕获 (对接真实API逻辑)
            const macro = {
                usd: 102.45,
                nas: "+0.78%",
                north: (Math.random()*40 + 10).toFixed(2),
                oil: 73.2,
                speech: "【操盘大脑】当前北向持续净流入，资源类标的（金/油）受宏观支撑。操作建议：严格执行低吸，不追高。"
            };

            document.getElementById('m_usd').innerText = macro.usd;
            document.getElementById('m_nas').innerText = macro.nas;
            document.getElementById('m_nas').className = `text-[10px] font-bold ${macro.nas.includes('+')?'text-red-500':'text-green-500'}`;
            document.getElementById('m_north').innerText = "+" + macro.north;
            document.getElementById('m_north').className = "text-[10px] font-bold text-red-500";
            document.getElementById('m_oil').innerText = macro.oil;
            document.getElementById('brainSpeech').innerText = macro.speech;

            // 2. 渲染雷达列表
            const container = document.getElementById('radarList');
            container.innerHTML = "";
            for(let code in coreStocks) {
                const raw = await fetchGBK(`https://qt.gtimg.cn/q=${code}`);
                const d = raw.split('~');
                const score = calculateScore(d, macro);
                renderItem(d, score, container);
            }
            document.getElementById('updateTime').innerText = new Date().toLocaleTimeString();
            renderHistory();
        }

        function calculateScore(d, macro) {
            let s = 70;
            const pct = parseFloat(d[32]);
            if(pct > 0 && pct < 4) s += 15; // 稳健拉升区
            if(macro.north > 20 && (d[1].includes("矿") || d[1].includes("油"))) s += 10; // 资金共振
            if(pct > 6) s -= 30; // 追高风险惩罚
            return s;
        }

        function renderItem(d, score, container) {
            const isHot = score >= 85;
            const div = document.createElement('div');
            div.className = `p-4 flex justify-between items-center rounded-xl glass border ${isHot?'border-red-500 high-glow':'border-slate-800'}`;
            div.onclick = () => showDiagnosis(d, score);
            div.innerHTML = `
                <div>
                    <div class="text-[14px] font-black">${d[1]}</div>
                    <div class="text-[9px] text-slate-500">强度: ${score} | 换手: ${d[38]}%</div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-mono font-black">${d[3]}</div>
                    <div class="${parseFloat(d[32])>=0?'text-red-500':'text-green-500'} text-[10px]">${d[32]}%</div>
                </div>
            `;
            container.appendChild(div);
        }

        function showDiagnosis(d, score) {
            window.activeStock = d;
            document.getElementById('orderBox').classList.remove('hidden');
            const oc = document.getElementById('orderContent');
            const buyTarget = (parseFloat(d[3]) * 0.992).toFixed(2);
            oc.innerHTML = `
                <div class="bg-black/50 p-3 rounded-xl border border-slate-800">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-black text-emerald-400">${d[1]} 操盘逻辑</span>
                        <span class="text-[9px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">评分: ${score}</span>
                    </div>
                    <p class="text-[10px] text-slate-300 italic mb-3">系统探测：主力买入意愿强。建议入场位：<b class="text-white">${buyTarget}</b>（现价下浮0.8%）</p>
                    <div class="grid grid-cols-2 gap-4 text-[9px]">
                        <div class="text-red-400">止损位: ${(d[3]*0.96).toFixed(2)} (-4%)</div>
                        <div class="text-emerald-400 text-right">止盈位: ${(d[3]*1.08).toFixed(2)} (+8%)</div>
                    </div>
                </div>
            `;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function saveTrade(type) {
            const price = document.getElementById('backPrice').value;
            const qty = document.getElementById('backQty').value;
            if(!price || !qty) return alert("请完整填写价格和股数");
            
            let review = "";
            if(type === 'SELL') {
                review = prompt("【清仓复盘】请记录本次交易的成败关键(如:宏观变动、情绪波动、严格执行止损等):");
            }

            const record = {
                name: window.activeStock[1],
                price, qty, type, review,
                time: new Date().toLocaleString()
            };

            tradeMemory.unshift(record);
            localStorage.setItem('master_brain_v18', JSON.stringify(tradeMemory.slice(0, 15)));
            alert("大脑已同步记忆。");
            renderHistory();
        }

        function renderHistory() {
            const hb = document.getElementById('historyBox');
            hb.innerHTML = tradeMemory.length ? '<h3 class="text-[10px] font-black text-slate-500 uppercase px-1 py-2">超级大脑·操盘日志</h3>' : '';
            tradeMemory.forEach(log => {
                const div = document.createElement('div');
                div.className = `trade-card p-3 mb-2 text-[10px] ${log.type==='SELL'?'opacity-70 border-slate-500':''}`;
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-black ${log.type==='BUY'?'text-blue-400':'text-slate-400'}">${log.name} (${log.type === 'BUY'?'建仓':'清仓'})</span>
                        <span class="font-mono text-white">￥${log.price} x ${log.qty}</span>
                    </div>
                    <div class="text-slate-600 text-[8px]">${log.time}</div>
                    ${log.review ? `<div class="mt-2 text-emerald-500 border-t border-slate-800 pt-1 italic">复盘记忆: ${log.review}</div>` : ''}
                `;
                hb.appendChild(div);
            });
        }

        async function smartSearch() {
            const input = document.getElementById('newInput').value.trim();
            for(let c in coreStocks) if(coreStocks[c].includes(input)) {
                const raw = await fetchGBK(`https://qt.gtimg.cn/q=${c}`);
                showDiagnosis(raw.split('~'), 85);
                return;
            }
            alert("当前核心池未锁定该股，请确保名称准确。");
        }

        updateBrain();
        setInterval(updateBrain, 30000);
    </script>
</body>
</html>
