<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>博弈雷达 V9.5-双引擎版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: system-ui, -apple-system; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; margin-bottom: 0.75rem; }
        .high-glow { border: 1px solid #ef4444; box-shadow: 0 0 20px rgba(239,68,68,0.2); }
        .btn-active:active { transform: scale(0.96); opacity: 0.8; }
        #radarList::-webkit-scrollbar { width: 4px; }
        #radarList::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .logic-item { border-left: 2px solid #3b82f6; padding-left: 8px; margin-bottom: 8px; font-size: 10px; color: #cbd5e1; }
    </style>
</head>
<body class="p-3">
    <div class="max-w-md mx-auto">
        <div class="card p-3 border-t-4 border-red-600">
            <div class="flex justify-between items-center mb-2">
                <span id="updateTime" class="text-[10px] text-slate-500 font-mono italic">系统初始化...</span>
                <span class="text-[9px] bg-red-600 text-white px-2 py-0.5 rounded font-bold uppercase">2W VIP TERMINAL</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-black/30 p-2 rounded-lg">
                    <div class="text-[8px] text-slate-500 uppercase">博弈情绪</div>
                    <div id="mktScore" class="font-black text-sm">--</div>
                </div>
                <div id="mktAdvice" class="col-span-2 flex items-center justify-center bg-blue-500/5 rounded-lg text-[10px] font-bold text-blue-400 p-1 text-center">
                    正在同步 Alpha 信号流...
                </div>
            </div>
        </div>

        <div class="card p-3">
            <div id="radarList" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1">
                <div class="text-center py-10 text-slate-700 text-[10px]">正在侦察...</div>
            </div>
        </div>

        <div id="orderBox" class="hidden card p-4 border-l-4 border-emerald-500 bg-slate-900/90 animate-in fade-in duration-300">
            <div id="orderContent"></div>
        </div>

        <div class="card p-4 bg-slate-900 border-blue-500/20 shadow-2xl">
            <div class="flex gap-2">
                <input id="newInput" type="text" placeholder="输入名称或代码 (如: 紫金)" class="flex-1 bg-black border border-slate-800 p-2.5 rounded-xl text-xs outline-none text-white focus:border-blue-500 transition-all">
                <button onclick="smartSearch()" class="bg-blue-600 text-white px-6 rounded-xl text-[11px] font-black btn-active">分析</button>
            </div>
            <p id="searchStatus" class="text-[8px] text-slate-600 mt-2 italic text-center">支持模糊匹配：输入“紫金”或“ZJKY”即可。</p>
        </div>
    </div>

    <script>
        // 内置 200 只重点股数据（包含名称映射，确保搜索必中）
        const stockDB = {
            'sh601899':'紫金矿业', 'sh601857':'中国石油', 'sh600028':'中国石化', 'sh601088':'中国神华',
            'sh601225':'陕西煤业', 'sh601898':'中煤能源', 'sh601958':'金钼股份', 'sh601600':'中国铝业',
            'sh603993':'洛阳钼业', 'sh601288':'农业银行', 'sh600030':'中信证券', 'sz000001':'平安银行',
            'sz000725':'京东方A', 'sz002460':'赣锋锂业', 'sz002466':'天齐锂业', 'sh601318':'中国平安'
        };
        let corePool = Object.keys(stockDB);

        async function fetchGBK(url) {
            try {
                const resp = await fetch(url);
                return new TextDecoder('gbk').decode(await resp.arrayBuffer());
            } catch(e) { return ""; }
        }

        async function smartSearch() {
            const input = document.getElementById('newInput').value.trim();
            if(!input) return;
            const status = document.getElementById('searchStatus');
            status.innerText = "匹配中...";

            // 1. 本地库模糊搜索 (优先)
            let foundCode = "";
            for (let code in stockDB) {
                if (stockDB[code].includes(input) || code.includes(input)) {
                    foundCode = code;
                    break;
                }
            }

            // 2. 如果本地没找到，走云端接口
            if (!foundCode) {
                try {
                    const suggestUrl = `https://smartbox.gtimg.cn/s3/?v=2&q=${encodeURIComponent(input)}&t=all`;
                    const resp = await fetch(suggestUrl).then(r => r.text());
                    const match = resp.match(/"([^"]+)"/);
                    if (match && match[1]) {
                        const data = match[1].split('~');
                        foundCode = data[0] + data[1];
                    }
                } catch(e) {}
            }

            if (foundCode) {
                if (!corePool.includes(foundCode)) corePool.unshift(foundCode);
                await updateRadar();
                const detail = await fetchGBK(`https://qt.gtimg.cn/q=${foundCode}`);
                showOrder(detail.split('~'));
                document.getElementById('newInput').value = "";
                status.innerText = "分析成功";
            } else {
                status.innerText = "未找到该股票，请尝试输入纯代码";
            }
        }

        async function updateRadar() {
            try {
                const mktText = await fetchGBK(`https://qt.gtimg.cn/q=sh000001`);
                const shPct = parseFloat(mktText.split('~')[32]) || 0;
                document.getElementById('mktScore').innerText = shPct >= 0 ? "红盘多头" : "防守震荡";
                document.getElementById('mktAdvice').innerText = shPct >= 0 ? "策略：积极参与高分龙头，严守止损" : "策略：控制仓位，等待缩量企稳";

                let allResults = [];
                const batchSize = 10;
                for (let i = 0; i < corePool.length; i += batchSize) {
                    const batch = corePool.slice(i, i + batchSize).join(',');
                    const resp = await fetchGBK(`https://qt.gtimg.cn/q=${batch}`);
                    resp.split(';').filter(l => l.length > 30).forEach(line => {
                        const d = line.split('~');
                        allResults.push({ d, score: calcScore(d) });
                    });
                }
                allResults.sort((a, b) => b.score - a.score);
                const container = document.getElementById('radarList');
                container.innerHTML = "";
                allResults.forEach(item => renderItem(item.d, item.score));
                document.getElementById('updateTime').innerText = "最后更新 " + new Date().toLocaleTimeString();
            } catch (e) {}
        }

        function calcScore(d) {
            const pct = parseFloat(d[32]) || 0, vol = parseFloat(d[36]) || 0;
            let s = 60;
            if(pct > 1.5) s += 15; if(vol > 1.3) s += 15;
            if(pct < 0) s -= 30;
            return s;
        }

        function renderItem(d, score) {
            const pct = parseFloat(d[32]), isStrong = score >= 75;
            const div = document.createElement('div');
            div.className = `flex justify-between items-center p-3 rounded-xl bg-slate-900/50 border ${isStrong ? 'border-red-500/40 high-glow' : 'border-slate-800'}`;
            div.onclick = () => showOrder(d);
            div.innerHTML = `<div><div class="text-[13px] font-black">${d[1]}</div><div class="text-[9px] text-slate-500">${d[0].split('_').pop().split('=')[0]} | 换手 ${d[38]}%</div></div><div class="flex items-center gap-4"><div><div class="${pct>=0?'text-red-500':'text-green-500'} font-black text-sm">${d[3]}</div><div class="${pct>=0?'text-red-500':'text-green-500'} text-[10px] text-right">${pct}%</div></div><div class="text-sm font-black ${isStrong?'text-red-500':'text-slate-600'}">${score}</div></div>`;
            document.getElementById('radarList').appendChild(div);
        }

        function showOrder(d) {
            const p = parseFloat(d[3]), r = p * 0.04, stop = (p - r).toFixed(2), t1 = (p + r).toFixed(2), t2 = (p + r * 2).toFixed(2);
            const shares = Math.floor(400 / r / 100) * 100;
            const cost = (shares * p).toFixed(0);
            
            let logic = ``;
            if (d[1].includes("石油") || d[1].includes("矿") || d[1].includes("煤")) {
                logic = `<div class="logic-item"><b>[资源属性]</b> 全球通胀周期下，作为上游龙头具备极强筹码护城河。</div><div class="logic-item"><b>[买入逻辑]</b> 2W本金建议配置底仓，跟随大宗商品趋势获利。</div>`;
            } else {
                logic = `<div class="logic-item"><b>[博弈形态]</b> 当前成交量活跃，分时线重心不断上移。</div><div class="logic-item"><b>[买入逻辑]</b> 属于强势股右侧交易模型，需紧盯止损位。</div>`;
            }

            document.getElementById('orderBox').classList.remove('hidden');
            document.getElementById('orderContent').innerHTML = `
                <div class="flex justify-between border-b border-emerald-500/20 pb-2 mb-3"><span class="text-sm font-black text-white">${d[1]} 2W专供逻辑</span><span class="text-[10px] text-emerald-500">${shares}股 (¥${cost})</span></div>
                <div class="mb-3">${logic}</div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-black/50 p-2 rounded-lg border border-slate-800"><div class="text-[8px] text-slate-500">买入</div><div class="text-xs font-black">${p}</div></div>
                    <div class="bg-red-500/10 p-2 rounded-lg border border-red-500/20"><div class="text-[8px] text-red-500">止损</div><div class="text-xs font-black text-red-500">${stop}</div></div>
                    <div class="bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20"><div class="text-[8px] text-emerald-500">保本位</div><div class="text-xs font-black text-emerald-500">${t1}</div></div>
                </div>
                <div class="text-center text-emerald-400 font-bold text-[10px] mt-2 italic">止盈预期位：¥${t2}</div>
            `;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        updateRadar();
        setInterval(updateRadar, 30000);
    </script>
</body>
</html>
