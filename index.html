<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>博弈雷达 V19.5-终极全闭环版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'PingFang SC', system-ui; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.4); }
        .macro-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.3); padding: 8px; border-radius: 10px; }
        .high-glow { border: 1px solid #ef4444; box-shadow: 0 0 15px rgba(239,68,68,0.15); }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="p-3 bg-slate-950 min-h-screen">

    <div class="max-w-md mx-auto space-y-4 pb-20">
        
        <header class="glass p-4 rounded-2xl border-t-2 border-blue-500 shadow-2xl">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-black text-blue-400 uppercase">Global Macro Commander</span>
                <span id="updateTime" class="text-[9px] text-slate-500 font-mono italic">正在对齐全球数据...</span>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="macro-card">
                    <div class="text-[8px] text-slate-500 uppercase">上海黄金 / 伦敦金</div>
                    <div class="text-[10px] font-bold text-white"><span id="sh_gold">628.5</span> / <span id="ld_gold">2658</span></div>
                </div>
                <div class="macro-card">
                    <div class="text-[8px] text-slate-500 uppercase">非农就业 / 美元</div>
                    <div class="text-[10px] font-bold text-white"><span id="non_farm">22.5万</span> / <span id="m_usd">102.5</span></div>
                </div>
                <div class="macro-card col-span-2">
                    <div class="text-[8px] text-slate-500 uppercase">北向资金 & 纳指预期</div>
                    <div class="flex justify-between mt-1">
                        <span id="m_north" class="text-[10px] font-bold text-red-500">+42.8亿</span>
                        <span id="m_nas" class="text-[10px] font-bold text-red-500">+0.85%</span>
                    </div>
                </div>
            </div>

            <div id="brainSpeech" class="text-[11px] text-amber-200 bg-amber-500/10 p-2.5 rounded-xl border border-amber-500/20 leading-relaxed italic">
                初始化决策引擎...
            </div>
        </header>

        <main id="radarList" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1">
            </main>

        <section class="glass p-4 rounded-2xl border-t-2 border-emerald-500 shadow-xl">
            <div class="flex gap-2 mb-4">
                <input id="newInput" type="text" placeholder="输入名称(如:紫金矿业)" class="flex-1 bg-black border border-slate-800 p-3 rounded-xl text-xs text-white outline-none focus:border-emerald-500">
                <button onclick="smartSearch()" class="bg-emerald-600 px-6 rounded-xl text-xs font-black text-white">诊断</button>
            </div>

            <div id="orderBox" class="hidden space-y-3">
                <div id="orderContent"></div>
                <div class="grid grid-cols-2 gap-2 pt-3 border-t border-slate-800">
                    <input id="backPrice" type="number" step="0.01" placeholder="成交单价" class="bg-black border border-slate-800 p-2 rounded-lg text-xs text-white">
                    <input id="backQty" type="number" placeholder="股数" class="bg-black border border-slate-800 p-2 rounded-lg text-xs text-white">
                    <button onclick="saveTrade('BUY')" class="bg-blue-600 text-white py-2 rounded-lg text-[10px] font-black">记录建仓</button>
                    <button onclick="saveTrade('SELL')" class="bg-slate-700 text-slate-300 py-2 rounded-lg text-[10px] font-black">清仓复盘</button>
                </div>
            </div>
        </section>

        <div id="historyBox" class="space-y-2 p-1 pb-10"></div>
    </div>

    <script>
        // 核心数据库：你要求的标的全部在内
        const stockDB = {'sh601899':'紫金矿业','sh601857':'中国石油','sh603993':'洛阳钼业','sz000725':'京东方A','sh601288':'农业银行','sh600028':'中国石化','sh601225':'陕西煤业'};
        let memory = JSON.parse(localStorage.getItem('final_brain_v19')) || [];

        async function updateBrain() {
            // 1. 模拟宏观数据与非农/黄金逻辑
            const macro = {
                sh_gold: 628.5, ld_gold: 2658, non_farm: "22.5万", usd: 102.5,
                north: "+38.2", nas: "+0.85%",
                logic: "【上帝视角】非农超预期利好美元，黄金及大宗商品短期承压。建议：重点观察洛阳钼业回撤后的低吸机会。"
            };
            document.getElementById('sh_gold').innerText = macro.sh_gold;
            document.getElementById('ld_gold').innerText = macro.ld_gold;
            document.getElementById('non_farm').innerText = macro.non_farm;
            document.getElementById('m_usd').innerText = macro.usd;
            document.getElementById('brainSpeech').innerText = macro.logic;

            // 2. 渲染股票池逻辑
            const container = document.getElementById('radarList');
            container.innerHTML = "";
            for(let code in stockDB) {
                const raw = await fetch(`https://qt.gtimg.cn/q=${code}`).then(r => r.arrayBuffer()).then(b => new TextDecoder('gbk').decode(b));
                const d = raw.split('~');
                const score = calculateEliteScore(d, macro);
                renderItem(d, score, container);
            }
            document.getElementById('updateTime').innerText = new Date().toLocaleTimeString();
            renderHistory();
        }

        function calculateEliteScore(d, macro) {
            let s = 75;
            const pct = parseFloat(d[32]);
            if(pct > 0 && pct < 4) s += 10;
            // 非农数据对资源股的负面修正
            if(macro.usd > 102 && (d[1].includes("矿") || d[1].includes("油"))) s -= 5;
            if(pct > 6) s -= 30; // 追高风险
            return s;
        }

        function renderItem(d, score, container) {
            const isHigh = score >= 85;
            const div = document.createElement('div');
            div.className = `p-4 flex justify-between items-center rounded-xl glass border ${isHigh?'border-red-500 high-glow':'border-slate-800'}`;
            div.onclick = () => showDiagnosis(d, score);
            div.innerHTML = `<div><div class="text-[14px] font-black">${d[1]}</div><div class="text-[9px] text-slate-500">评分: ${score} | 换手: ${d[38]}%</div></div><div class="text-right"><div class="text-sm font-black text-white">${d[3]}</div><div class="${parseFloat(d[32])>=0?'text-red-500':'text-green-500'} text-[10px]">${d[32]}%</div></div>`;
            container.appendChild(div);
        }

        function showDiagnosis(d, score) {
            window.activeStock = d;
            document.getElementById('orderBox').classList.remove('hidden');
            const oc = document.getElementById('orderContent');
            const buyTarget = (parseFloat(d[3]) * 0.992).toFixed(2);
            // 2W 专供逻辑计算
            const qty = Math.floor(10000 / parseFloat(d[3]) / 100) * 100; 

            oc.innerHTML = `
                <div class="bg-black/50 p-3 rounded-xl border border-slate-800">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-black text-emerald-400">${d[1]} 2W专供分析</span>
                        <span class="text-[9px] text-slate-500">建议股数: ${qty}</span>
                    </div>
                    <p class="text-[10px] text-slate-300 italic mb-2">宏观环境：${score >= 80 ? '利多共振' : '观望为主'}。建议回踩入场位：<b class="text-white">${buyTarget}</b></p>
                    <div class="flex justify-between text-[9px]">
                        <span class="text-red-400 font-bold">止损: ${(d[3]*0.96).toFixed(2)}</span>
                        <span class="text-emerald-400 font-bold">止盈: ${(d[3]*1.08).toFixed(2)}</span>
                    </div>
                </div>
            `;
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function saveTrade(type) {
            const price = document.getElementById('backPrice').value;
            const qty = document.getElementById('backQty').value;
            if(!price || !qty) return alert("记录失败：请填写成交价和股数");
            
            let review = "";
            if(type === 'SELL') review = prompt("【复盘大脑】本次清仓主要由于什么原因？(例如：止损离场、非农利空、严格止盈)");

            const record = { name: window.activeStock[1], price, qty, type, review, time: new Date().toLocaleString() };
            memory.unshift(record);
            localStorage.setItem('final_brain_v19', JSON.stringify(memory.slice(0, 10)));
            alert("大脑已存入记忆。");
            renderHistory();
        }

        function renderHistory() {
            const hb = document.getElementById('historyBox');
            hb.innerHTML = memory.length ? '<h3 class="text-[10px] font-black text-slate-500 uppercase px-1 py-2">操盘日志记忆</h3>' : '';
            memory.forEach(log => {
                const div = document.createElement('div');
                div.className = `p-3 mb-2 rounded-xl bg-slate-900 border-l-4 ${log.type==='BUY'?'border-blue-500':'border-slate-500 opacity-70'} text-[10px]`;
                div.innerHTML = `<div class="flex justify-between font-black"><span>${log.name} (${log.type === 'BUY'?'建仓':'清仓'})</span><span>￥${log.price} x ${log.qty}</span></div><div class="text-slate-600 text-[8px] mt-1">${log.time}</div>${log.review ? `<div class="mt-2 text-emerald-500 italic">复盘：${log.review}</div>` : ''}`;
                hb.appendChild(div);
            });
        }

        async function smartSearch() {
            const input = document.getElementById('newInput').value.trim();
            for(let c in stockDB) if(stockDB[c].includes(input)) {
                const raw = await fetch(`https://qt.gtimg.cn/q=${c}`).then(r => r.arrayBuffer()).then(b => new TextDecoder('gbk').decode(b));
                showDiagnosis(raw.split('~'), 85);
                return;
            }
            alert("核心池未检索到，建议检查名称");
        }

        updateBrain();
        setInterval(updateBrain, 60000);
    </script>
</body>
</html>
